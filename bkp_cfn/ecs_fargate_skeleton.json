{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Parameters":{
     "VpcId":{
        "Type":"AWS::EC2::VPC::Id",
        "Description":"Select a VPC that allows instances to access the Internet."
     },
     "ApplicationSubnets":{
        "Type":"List<AWS::EC2::Subnet::Id>",
        "Description":"Select at least two application subnets in your selected VPC."
     },
     "WebSubnets":{
        "Type":"List<AWS::EC2::Subnet::Id>",
        "Description":"Select atleast two web subnets in your selected VPC."
     },
     "PublicSubnets":{
        "Type":"List<AWS::EC2::Subnet::Id>",
        "Description":"Select atleast two public subnets in your selected VPC."
     },
     "Environment":{
        "Type":"String",
        "Description":"Environment Name ",
        "AllowedValues":[
           "stage",
           "prod"
        ]
     },
     "Region":{
        "Description":"Region to deploy this infrastructure",
        "Type":"String",
        "Default":"us-east-1",
        "AllowedValues":[
           "us-east-1"
        ],
        "ConstraintDescription":"Please choose a Region to deploy this infrastructure"
     },
     "ALBSubnets":{
        "Type":"String",
        "Description":"ALB is Public or Private",
        "AllowedValues":[
           "public",
           "web"
        ]
     },
     "CertificateARN":{
        "Type":"String",
        "Description":"CertificateARN of the desired  environment"
     },
     "Product":{
        "Type":"String",
        "Description":"Product Name"
     },
     "ApplicationName":{
        "Type":"String",
        "Description":"Application Name"
     },
     "ProductOwnerEmail":{
        "Type":"String",
        "Description":"Email ID of the product owner"
     },
     "ApplicationOwnerEmail":{
        "Type":"String",
        "Description":"Email ID of the application owner"
     },
     "CommonALBSecurityGroups":{
        "Type":"CommaDelimitedList",
        "Description":"Common ALB Security Groups"
     },
     "Purpose":{
        "Type":"String",
        "Description":"Purpose for creating this instance like POC/Business"
     }
  },
  "Conditions":{
     "ALBCommonSGs":{
        "Fn::Not":[
           {
              "Fn::Equals":[
                 "",
                 {
                    "Fn::Join":[
                       "",
                       {
                          "Ref":"CommonALBSecurityGroups"
                       }
                    ]
                 }
              ]
           }
        ]
     },
     "ALBScheme":{
        "Fn::Equals":[
           {
              "Ref":"ALBSubnets"
           },
           "web"
        ]
     }
  },
  "Resources":{
     "ALBSecurityGroup":{
        "Type":"AWS::EC2::SecurityGroup",
        "Properties":{
           "GroupName":{
              "Fn::Join":[
                 "-",
                 [
                    {
                      "Ref":"Environment"
                    },
                    {
                       "Ref":"Product"
                    },
                    {
                       "Ref":"ApplicationName"
                    },
                    "alb-SG"
                 ]
              ]
           },
           "GroupDescription":"Allow http to client host",
           "VpcId":{
              "Ref":"VpcId"
           },
           "Tags":[
              {
                 "Key":"Name",
                 "Value":{
                    "Fn::Join":[
                       "-",
                       [
                        {
                          "Ref":"Environment"
                        },
                          {
                             "Ref":"Product"
                          },
                          {
                             "Ref":"ApplicationName"
                          },
                          "alb-SG"
                       ]
                    ]
                 }
              }
           ]
        }
     },
     "ECSCluster":{
        "Type":"AWS::ECS::Cluster",
        "Properties":{
           "ClusterName":{
              "Fn::Join":[
                 "-",
                 [  
                   {
                    "Ref":"Environment"
                    },
                    {
                       "Ref":"Product"
                    },
                    {
                       "Ref":"ApplicationName"
                    }
                 ]
              ]
           }
        }
     },
     "ECSTargetGroup":{
        "Type":"AWS::ElasticLoadBalancingV2::TargetGroup",
        "Properties":{
           "HealthCheckIntervalSeconds":20,
           "HealthCheckPath":"/",
           "HealthCheckProtocol":"HTTP",
           "HealthCheckTimeoutSeconds":5,
           "HealthyThresholdCount":2,
           "Name":{
              "Fn::Join":[
                 "-",
                 [
                  {
                    "Ref":"Environment"
                  },
                    {
                       "Ref":"Product"
                    },
                    {
                       "Ref":"ApplicationName"
                    },
                    "TG"
                 ]
              ]
           },
           "Port":80,
           "Protocol":"HTTP",
           "UnhealthyThresholdCount":10,
           "VpcId":{
              "Ref":"VpcId"
           }
        }
     },
     "ALBLogsS3":{
      "Type" : "AWS::S3::Bucket",
      "Properties" : {
          "BucketName" : {
            "Fn::Join":[
               "-",
               [  
                {
                  "Ref":"Environment"
                },
                  {
                     "Ref":"Product"
                  },
                  {
                     "Ref":"ApplicationName"
                  },
                  "alb-logs"
               ]
            ]
         },
          "Tags" : [
            {
               "Key":"ApplicationOwner",
               "Value":{
                  "Ref":"ApplicationOwnerEmail"
               }
            },
            {
               "Key":"ProductOwner",
               "Value":{
                  "Ref":"ProductOwnerEmail"
               }
            },
            {
               "Key":"Purpose",
               "Value":{
                  "Ref":"Purpose"
               }
            },
            {
               "Key":"Name",
               "Value":{
                "Fn::Join":[
                   "-",
                   [  
                    {
                      "Ref":"Environment"
                    },
                      {
                         "Ref":"Product"
                      },
                      {
                         "Ref":"ApplicationName"
                      },
                      "alb-logs"
                   ]
                ]
             }
            },
            {
               "Key":"ApplicationRole",
               "Value":"Application Load Balancer"
            },
            {
               "Key":"Environment",
               "Value":{
                  "Ref":"Environment"
               }
            },
            {
               "Key":"Product",
               "Value":{
                  "Ref":"Product"
               }
            }
         ]
        }
    },
    "ALBLogsS3BucketPolicy": {
      "Type" : "AWS::S3::BucketPolicy",
      "Properties" : {
          "Bucket" : {
            "Ref":"ALBLogsS3"
         },
          "PolicyDocument" : {
            "Version": "2012-10-17",
            "Id": "AWSConsole-AccessLogs-Policy-1595067447415",
            "Statement": [
                {
                    "Sid": "AWSConsoleStmt-1595067447415",
                    "Effect": "Allow",
                    "Principal": {
                        "AWS": "arn:aws:iam::127311923021:root"
                    },
                    "Action": "s3:PutObject",
                    "Resource": { "Fn::Join" : [ "", [ { "Fn::GetAtt" : [ "ALBLogsS3", "Arn" ] }, "/AWSLogs/410666792966/*"] ] }
                },
                {
                    "Sid": "AWSLogDeliveryWrite",
                    "Effect": "Allow",
                    "Principal": {
                        "Service": "delivery.logs.amazonaws.com"
                    },
                    "Action": "s3:PutObject",
                    "Resource": { "Fn::Join" : [ "", [ { "Fn::GetAtt" : [ "ALBLogsS3", "Arn" ] }, "/AWSLogs/410666792966/*"] ] },
                    "Condition": {
                        "StringEquals": {
                            "s3:x-amz-acl": "bucket-owner-full-control"
                        }
                    }
                },
                {
                    "Sid": "AWSLogDeliveryAclCheck",
                    "Effect": "Allow",
                    "Principal": {
                        "Service": "delivery.logs.amazonaws.com"
                    },
                    "Action": "s3:GetBucketAcl",
                    "Resource": { "Fn::GetAtt" : [ "ALBLogsS3", "Arn" ] }
                }
            ]
        }
        },
        "DependsOn" : "ALBLogsS3"
    },
     "ALB":{
        "Type":"AWS::ElasticLoadBalancingV2::LoadBalancer",
        "Properties":{
           "Name":{
              "Fn::Join":[
                 "-",
                 [  
                  {
                    "Ref":"Environment"
                  },
                    {
                       "Ref":"Product"
                    },
                    {
                       "Ref":"ApplicationName"
                    },
                    "alb"
                 ]
              ]
           },
           "Scheme":{
              "Fn::If":[
                 "ALBScheme",
                 "internal",
                 "internet-facing"
              ]
           },
           "LoadBalancerAttributes":[
              {
                 "Key":"idle_timeout.timeout_seconds",
                 "Value":"60"
              },
              {
                "Key":"access_logs.s3.enabled",
                "Value":"true"
              },
              {
                "Key":"access_logs.s3.bucket",
                "Value":{
                  "Ref":"ALBLogsS3"
               }
              }
           ],
           "Subnets":{
              "Fn::If":[
                 "ALBScheme",
                 {
                    "Ref":"WebSubnets"
                 },
                 {
                    "Ref":"PublicSubnets"
                 }
              ]
           },
           "SecurityGroups":{
              "Fn::If":[
                 "ALBCommonSGs",
                 {
                    "Fn::Split":[
                       ",",
                       {
                          "Fn::Join":[
                             ",",
                             [
                                {
                                   "Ref":"ALBSecurityGroup"
                                },
                                {
                                   "Fn::Join":[
                                      ",",
                                      {
                                         "Ref":"CommonALBSecurityGroups"
                                      }
                                   ]
                                }
                             ]
                          ]
                       }
                    ]
                 },
                 {
                    "Fn::Split":[
                       ",",
                       {
                          "Ref":"ALBSecurityGroup"
                       }
                    ]
                 }
              ]
           },
        "Tags":[
           {
              "Key":"ApplicationOwner",
              "Value":{
                 "Ref":"ApplicationOwnerEmail"
              }
           },
           {
              "Key":"ProductOwner",
              "Value":{
                 "Ref":"ProductOwnerEmail"
              }
           },
           {
              "Key":"Purpose",
              "Value":{
                 "Ref":"Purpose"
              }
           },
           {
              "Key":"Name",
              "Value":{
                 "Fn::Join":[
                    "-",
                    [
                      {
                        "Ref":"Environment"
                      },
                       {
                          "Ref":"Product"
                       },
                       {
                          "Ref":"ApplicationName"
                       },
                       "alb"
                    ]
                 ]
              }
           },
           {
              "Key":"ApplicationRole",
              "Value":"Application Load Balancer"
           },
           {
              "Key":"Environment",
              "Value":{
                 "Ref":"Environment"
              }
           },
           {
              "Key":"Product",
              "Value":{
                 "Ref":"Product"
              }
           }
        ]
     },
     "DependsOn" : "ALBLogsS3"
    },
  "ALBListener":{
     "Type":"AWS::ElasticLoadBalancingV2::Listener",
     "DependsOn":"ALB",
     "Properties":{
        "Certificates":[
           {
              "CertificateArn":{
                 "Ref":"CertificateARN"
              }
           }
        ],
        "DefaultActions":[
           {
              "Type":"forward",
              "TargetGroupArn":{
                 "Ref":"ECSTargetGroup"
              }
           }
        ],
        "LoadBalancerArn":{
           "Ref":"ALB"
        },
        "Port":"443",
        "Protocol":"HTTPS",
        "SslPolicy":"ELBSecurityPolicy-TLS-1-2-Ext-2018-06"
     }
  },
  "LogGroup":{
     "Type":"AWS::Logs::LogGroup",
     "Properties":{
        "LogGroupName":{
           "Fn::Join":[
              "-",
              [
                {
                  "Ref":"Environment"
                },
                 {
                    "Ref":"Product"
                 },
                 {
                    "Ref":"ApplicationName"
                 }
              ]
           ]
        }
     }
  }
},
  "Outputs":{
     "ecscluster":{
        "Value":{
           "Ref":"ECSCluster"
        },
        "Export":{
           "Name":{
              "Fn::Sub":"${AWS::StackName}-ECSCluster"
           }
        }
     },
     "ALB":{
        "Description":"Your ALB DNS URL",
        "Value":{
           "Fn::Join":[
              "",
              [
                 {
                    "Fn::GetAtt":[
                       "ALB",
                       "DNSName"
                    ]
                 }
              ]
           ]
        }
     },
     "TargetGroupListenerARN":{
        "Description":"ARN of TargetGroup",
        "Value":{
           "Ref":"ALBListener"
        },
        "Export":{
           "Name":{
              "Fn::Sub":"${AWS::StackName}-TargetGroupListenerARN"
           }
        }
     },
     "LogGroup":{
        "Description":"Log Group for the service",
        "Value":{
           "Ref":"LogGroup"
        },
        "Export":{
           "Name":{
              "Fn::Sub":"${AWS::StackName}-LogGroup"
           }
        }
     }
  }
}